<!DOCTYPE html>
<html lang="tr">
  <head>
    <base target="_top" />
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <?!= include('styles'); ?>
    <style>
      .header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        flex-wrap: wrap;
        gap: 10px;
      }
      .search-bar {
        flex-grow: 1;
        margin-right: 10px;
      }
      .button-group {
        display: flex;
        gap: 10px;
      }
      table {
        width: 100%;
        border-collapse: collapse;
      }
      th,
      td {
        padding: 10px;
        border-bottom: 1px solid #ddd;
        text-align: left;
      }
      .sort-btn {
        padding: 5px 10px;
        font-size: 0.9rem;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h2>Faturalarƒ± G√∂r√ºnt√ºle</h2>
      <div class="header">
        <input
          type="text"
          class="search-bar"
          id="searchInput"
          placeholder="Fatura No ile ara..."
          oninput="filterFaturalar()"
        />
        <div class="button-group">
          <button class="btn-green" onclick="viewFaturalar('fatura')">
            Fatura G√∂r√ºnt√ºle
          </button>
          <button class="btn-red" onclick="viewFaturalar('proforma')">
            Proforma G√∂r√ºnt√ºle
          </button>
          <button class="btn-blue sort-btn" onclick="sortFaturalar('asc')">
            Tarih ‚Üë
          </button>
          <button class="btn-blue sort-btn" onclick="sortFaturalar('desc')">
            Tarih ‚Üì
          </button>
        </div>
      </div>
      <table>
        <thead>
          <tr>
            <th>Fatura No</th>
            <th>M√º≈üteri</th>
            <th>Tarih</th>
            <th>Tutar</th>
            <th>ƒ∞≈ülemler</th>
          </tr>
        </thead>
        <tbody id="faturaTableBody"></tbody>
      </table>
    </div>
    <script>
      let faturaData = [];
      let currentType = "fatura";

      google.script.run
        .withSuccessHandler((isAllowed) => {
          if (!isAllowed)
            document.body.innerHTML =
              "<h2 style='color: red; text-align: center;'>Eri≈üim izniniz yok!</h2>";
          else viewFaturalar("fatura");
        })
        .checkAccess();

      function viewFaturalar(type) {
        currentType = type;
        google.script.run
          .withSuccessHandler((data) => {
            console.log("Received data:", data);
            faturaData = Array.isArray(data) ? data : [];
            renderFaturalar(faturaData);
          })
          .withFailureHandler((error) => {
            console.error("Failed to load data:", error);
            Swal.fire("Hata!", error.message, "error");
            faturaData = [];
            renderFaturalar(faturaData);
          })
          .getFaturaList(type);
      }

      function renderFaturalar(data) {
        const tbody = document.getElementById("faturaTableBody");
        tbody.innerHTML = "";
        if (data.length === 0) {
          tbody.innerHTML = "<tr><td colspan='5'>Veri bulunamadƒ±.</td></tr>";
          return;
        }
        data.forEach((item, index) => {
          const row = document.createElement("tr");
          row.innerHTML = `
            <td>${item.faturaNo || "Bilinmiyor"}</td>
            <td>${item.musteri || "Bilinmiyor"}</td>
            <td>${item.tarih || "Bilinmiyor"}</td>
            <td>${item.tutar || "Bilinmiyor"}</td>
            <td>
              <button class="btn-blue" onclick="viewPDF('${
                item.pdfUrl
              }')">üîç</button>
              <button class="btn-blue" onclick="editFatura(${index}, '${currentType}')">‚úèÔ∏è</button>
            </td>
          `;
          tbody.appendChild(row);
        });
      }

      function filterFaturalar() {
        const query = document
          .getElementById("searchInput")
          .value.toLowerCase();
        if (!Array.isArray(faturaData)) {
          console.warn("faturaData is not an array:", faturaData);
          return;
        }
        const filteredData = faturaData.filter((item) =>
          (item.faturaNo || "").toLowerCase().includes(query)
        );
        renderFaturalar(filteredData);
      }

      function sortFaturalar(order) {
        if (!Array.isArray(faturaData)) {
          console.warn("faturaData is not an array:", faturaData);
          return;
        }
        const sortedData = [...faturaData].sort((a, b) => {
          const dateA = new Date(a.tarih);
          const dateB = new Date(b.tarih);
          return order === "asc" ? dateA - dateB : dateB - dateA;
        });
        renderFaturalar(sortedData);
      }

      function viewPDF(url) {
        if (url) window.open(url, "_blank");
        else Swal.fire("Hata!", "PDF URL bulunamadƒ±.", "error");
      }

      function editFatura(index, type) {
        console.log(`Editing ${type} at index ${index}`);
        google.script.run
          .withSuccessHandler((data) => {
            console.log("Edit data received:", data);
            window.location.href = `${getAppUrl()}?page=${
              type === "fatura" ? "faturaKes" : "proformaKes"
            }&edit=${index}`;
          })
          .withFailureHandler((error) => {
            console.error("Edit failed:", error);
            Swal.fire("Hata!", error.message, "error");
          })
          .getFaturaByIndex(index, type);
      }

      function getAppUrl() {
        return "<?!= ScriptApp.getService().getUrl(); ?>";
      }
    </script>
  </body>
</html>
